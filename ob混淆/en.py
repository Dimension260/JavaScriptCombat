import requests
import binascii
from Crypto.Cipher import DES
from Crypto.Util.Padding import unpad
import json
import pandas as pd


url = 'https://www.endata.com.cn/API/GetData.ashx'

headers = {
    'user-agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36'
}

year = input('你想查第几年的票房：')

data = {
        'year': year,
        'MethodName': 'BoxOffice_GetYearInfoData'
}

resp = requests.post(url, headers=headers, data=data)

mi = resp.text
# print(mi)
# mi = '27B3A0C23E6C292CD9BBF15857ADF04FA8A7E49DF18870211E0C08BF234D785F61E842C06793BF6621F438A913DFE6D828A66BB984407FBA4B1965D8514664F9373CC0E99402E59055724E547A7A1916FD852E1EEF696A97BF13290CC00CCCFCAD43DD4D589FFD8625B9B792AE5B65447FCCEA11DF32C61FFDC291746C2B1B2DE046AEDC92C5C85DA7E78E7706B615534A747FCA878DF52C1009FEE90EC1DD21F6C1F36CF49D8CE9182547781A1510ECEEB80BDCD72F1E9EB6C3B76B0B9FDDD0CE1C7328F16BE6A9FBFD78EE2DE5B8AD691EB17D273C219A62372D1E28426C6C6A1D4E3C65981A55119691D6040AD0DE4EC9723C42FD8077CC71F8C6D04F567858C41761D1CC468EDEEB3F788BC088C1F88F3D5707B08C7BF1F9344AEC7BD1FF84FB363F5840C4D0B74D44C073DFE6D828A66BB986FF31BF537B877FD14664F9373CC0E99A8C7C3777552687540B7C33E03B1D74FEF7E591371C60AEEA202DE31C71291BB0A5E41B53C00C552579FC0391312D47EC26D2BA0E31F4923C81B2823A75A0607A92AD74B4A3670EE69E21DDA3646304F77EB4C024001370D975DACB7D1EA9081C2E004AAE3B83A28D940D955A35B57BC0E7991F415BB3224BBA41900FCAD9D18D60EF4B22C208ECA7A4A45012770D547A664536FBCE265B601BBEE68252A0874C898C925B86FC7A9766113841C5A39B2560D0CB54A2C1E97C96A27B993D47AE61D2282E48B713176E2176C02FD6FD74A207F20CDF3A16ECC72237C61FF9CCA347DDFF5EC72567D0C20F6D050C729AAC44266334F027AED798DB13E2A43C52C9C9FFE078501EE9C10CCE242948BC326FDCFE4E22B4F48F02A2B31DB441C31AFB319B8B7F7C67F279968A99AD24DE212CA216E3661D917C0682123E6F9EAE6BD848B589661DEB3E6DBB436E261216754BAD6B1520576864213234F53968A5451EF740058C332BD1752D46D6597B24CA18C8102A6902B30BD12C09AE28F700194C8BBBBEC191A56745E01572435369F49CC7C5EF782DD625433D127399BE12F40F75118B299CC2045312CA74601822AD2071D38FA82B8B9D6E3AE1C0BBA9DD9602A1F86AF82CA0E1D6B9AA33D1FC50E808A4B55228AF8A64879D03A42A56C021B4DD5E7D725859079B7EFC6E3EC24E71F6F831272D222C2774AE907DB4D981612F7B582AE563F3C965A2156F200E35ADF67FEB2B1E63E9A8266BFCDD34916F7287F3E9A887B8BCF4BBD94CF1A83AB6A8F18E054BB8B053B268DA5ACD424A95BB4812102DE0207EB98E124FAC8137D1342C49DE14BECBA2473F8F11B8DC1935F6500EDCFF8952C405C61820F2F13BF402690E8886F62C9934182987FAFC40F62219814A118F36ABFCC017C40BA3D3CF853842380A7825D3090455087636E57AA1D8A3483FF5B721C944918DD727C870CE365D115C4779FF1A8756685832D1A021021789EE1D87C08330BF005B88552BEE52428CC32FE8D78472A43FF3CBE2759DF0B023EE7AA786B6C36C6C3F30B81113FEAD964F5771FE62FF62D4C26B02ADDC2DFEC4533908CB4F4C820E8B896F9B2D52998F46040C3EB206553DCDB8B509FA4275DB9EE912925BB46AFBA99FF216F69BE2B31DB441C31AFB319B8B7F7C67F279968A99AD24DE212CA216E3661D917C068D3B59E0E659135DC8B589661DEB3E6DB2945BFC378154830D6B1520576864213D4BE1EF975D85BD2740058C332BD1752D46D6597B24CA18C8102A6902B30BD12C09AE28F700194C8DBBC88DD00BA42B501572435369F49CC7C5EF782DD625433D127399BE12F40F75118B299CC2045312CA74601822AD2071D38FA82B8B9D6E3AE1C0BBA9DD9602A1F86AF82CA0E1D6B9AA33D1FC50E808A31A0F01BA8A36D5C69775E3B69E566E88697280657959363EFC6E3EC24E71F6F831272D222C2774AF09F4FA2B1DC7D6BB582AE563F3C965A0E54C9458F99DF2E7061ECBB08A6D094BFCDD34916F7287F3E9A887B8BCF4BBD94CF1A83AB6A8F18E054BB8B053B268DE677A13DE9D5C212489B95AB4EDE221C6EA9A99BE5E29B6F9DE14BECBA2473F88B7DE230174270B1EDCFF8952C405C61820F2F13BF402690E8886F62C9934182987FAFC40F622198F2C3F233C926756080733C0C237E2B5A2380A7825D3090455087636E57AA1D8A3483FF5B721C944918DD727C870CE365D115C4779FF1A8756685832D1A021021789EE1D87C08330BF005B88552BEE524B71B0D7DE918574FBFBAC380B478BF4EBABB1F77C81FD296C6C3F30B81113FEAD964F5771FE62FF6F11AFB841E71C53DEC4533908CB4F4C8710D3BDEF25C3EDEF65022DDDBF064BAE68F3E165033912EF696A97BF13290CC970ED9A5C96D0D1769CF026C06DBFF3EE5B65447FCCEA11D93EF19E52BDC779BC2B1B2DE046AEDC95DDE4569FA23A1836B615534A747FCA8A994C4A908F6CEEBEC1DD21F6C1F36CF49D8CE9182547781A1510ECEEB80BDCD72F1E9EB6C3B76B086AE195DD4256E594C998ABD66A521B4DE5B8AD691EB17D273C219A62372D1E28426C6C6A1D4E3C65981A55119691D6040AD0DE4EC9723C42FD8077CC71F8C6D04F567858C41761D1CC468EDEEB3F788ECAE642B28B6D38AF31A9613829AD6F4A1A1ADA1ED976B39840C4D0B74D44C073DFE6D828A66BB981805FCA07143E10D14664F9373CC0E99D6B0D1A44D044296328396899FA6686B4718DAFA4F0875A51D8764E06E55579EE546D87F1EEA7048A202DE31C71291BB66BAB8819D4B3D70579FC0391312D47E833913103FFBB011A0F021A604163A41A92AD74B4A3670EE01F58AFD2A0ADB6AD8A35E413DA831A7DE13C89F456983F3C2E004AAE3B83A28D940D955A35B57BC0E7991F415BB3224BBA41900FCAD9D18D60EF4B22C208ECA7A4A45012770D547A664536FBCE265B601BBEE68252A0874C898C925B86FC7A9766113841C5A39B2560D0CB54A2C1E97C96A27B993D47AE61D2282E48B713176190337964E4F8B1DBBB62D5B8FEB0AE290193A905165627064F32C0DA3FAD70120F6D050C729AAC4DA1135B80BAC2298CADD7D692C622AFF9FFE078501EE9C108AC20A0B2A18DB65EC00425EEA8279192B31DB441C31AFB319B8B7F7C67F279968A99AD24DE212CA216E3661D917C068F0A0A0559567EA9E8B589661DEB3E6DB2945BFC378154830D6B1520576864213B23566114DBFFE88740058C332BD1752D46D6597B24CA18C8102A6902B30BD12C09AE28F700194C8134D74CE144E6A5F01572435369F49CC7C5EF782DD625433D127399BE12F40F75118B299CC2045312CA74601822AD2071D38FA82B8B9D6E3AE1C0BBA9DD9602A1F86AF82CA0E1D6B559BA560C336A401082BF145D15032CDC61AF16B6D0BCD4E082023505DF068D5EFC6E3EC24E71F6F831272D222C2774A1279A54E85E09031B582AE563F3C965A90C3C0C1204FBD437A50D6B376E5312B27BCFD75ADB6DA6667F5B766C886CF65F0298494F98AD2113CD89F13516F783A5CE9B10E5EB1510149C28C1B1D5D207EDECEB592FB057BCE60FA4409884D2776551FB0D47478F47BDE13C89F456983F3C2E004AAE3B83A28D940D955A35B57BC0E7991F415BB3224BBA41900FCAD9D1845CBFBD0BA106FB07A4A45012770D547A664536FBCE265B601BBEE68252A0874C898C925B86FC7A9766113841C5A39B2560D0CB54A2C1E97C96A27B993D47AE61D2282E48B713176CFC13F2DA6DFA154FD451462AD8E36027CFE70938AE44B0F3169A4E125BA03DA20F6D050C729AAC493BAA22087E44C5105F9D3478BDB79C89FFE078501EE9C104517BDC4FC0E21D55C8E6886BF987D0EE13C2564CE19C15B90521D800BC03874BC25218EFCF39C61858452AF527FD573D95579014BC6322927E67C47B2A323FC8649915511ABF5CC414CF0E583D44F7D81C87D01432896CAD31DFC207745642A0EB195D9FE7F9D598B3B835F95CE86CFEC5691746B53ADBB1273DE1C87F5816C1E1C1E0C9A3340ABA91C89979172F971597A623CD5C8CA60A0B4789C9A7D9FA9895BDAAFB6F543AD44F164DBB2CF9106B78F7564AE388BA6875D0DB7D9028FFFDF947124F79CE86DC3E397D45DA1892FF5C3AD424D22B596F8FF319946BD952D27833E72ECD5D45F11EA442C6759A752EC2F2839088D7AD5853F84DFA530F02EAD3E9D86B2F99BCD34F4EFC060E353D81A46990C41684855CE992AAA4A41C33490521D800BC03874443DBB1AC4D38C4D661A476C3D2330CFD95579014BC6322962948EB47D79BB7DC2B1B2DE046AEDC9CC255359681C2CC16B615534A747FCA88693D77C3167A6967B21B7A80AC99B23007F082BED6E31E98102A6902B30BD12C09AE28F700194C839510D293D99830301572435369F49CC7C5EF782DD625433D127399BE12F40F75118B299CC2045312CA74601822AD2071D38FA82B8B9D6E3AE1C0BBA9DD9602A1F86AF82CA0E1D6B559BA560C336A401E82981FEBEB5A250827DED41D96777B55EA4386BD507A61FEFC6E3EC24E71F6F831272D222C2774AE05DD9319B37BA35B582AE563F3C965A25A55B7114FB7B092102C8EC7EC20789A202DE31C71291BB9606A8BBC09C4739579FC0391312D47E13684C38390D420057DB1661171FA6C97E507C42CF4B035F8E750F1BB343CA1298F26755B07E3DA5B6FF8903BB901976FDDA2654157B945E3782C7BB42402D29670474EE1DE3F67F83CB2D6DACFA9182AC6BD76F2535F3B0858DDCDB27285F3F54EC7BAB4ACD763BDDC64B6B062161FA3BBB534D16EE9B290B8D79A417226F9DA7901B1EE7E4623A6A1DA0D681BE61F21657F4DB4FA653E87259F011ED909704E8C70014CC2C33EF1B103DB2220B21238EEF143713B88F8E58FEE236BAB8058C65C317A91417F0DA166CAF1A3F0F849EBEA301C3443C12F8A669912BFA80B057F696A97BF13290CC970ED9A5C96D0D1769CF026C06DBFF3EE5B65447FCCEA11D3052301219B678F78B589661DEB3E6DB9BB3CD72A197471BD6B1520576864213FFD715E0F6F6597F740058C332BD1752D46D6597B24CA18C8102A6902B30BD12C09AE28F700194C83DA9F5103E41419701572435369F49CC7C5EF782DD625433D127399BE12F40F75118B299CC2045312CA74601822AD2071D38FA82B8B9D6E3AE1C0BBA9DD9602A1F86AF82CA0E1D6B559BA560C336A40176925556E471401E7CAC5343AD7F6F22079894D0540680F6EFC6E3EC24E71F6F831272D222C2774AF17D739A5216CD46B582AE563F3C965A91AAFA0287E970692D31C5D470CA823BA202DE31C71291BB9606A8BBC09C4739579FC0391312D47EFF464443ADB57DA881161B60EBF5FDDB2CF3BD255D66A29BECE2057DE4377C8C7E5C10E6443AB1DFB6FF8903BB901976FDDA2654157B945E3782C7BB42402D29670474EE1DE3F67F83CB2D6DACFA91821C0BF21E0B2E2047858DDCDB27285F3F54EC7BAB4ACD763BDDC64B6B062161FA3BBB534D16EE9B290B8D79A417226F9DA7901B1EE7E4623A6A1DA0D681BE61F21657F4DB4FA653E804B7FFD74C54BC62D6629191C9DC2B3167AFB5DFDD251C278EEF143713B88F8E58FEE236BAB8058C507C1226627A27B9BACB7E3C8CB49DB6BEA301C3443C12F878C216D8D1D18F6FB048348A4F5A14C27CCAA26D5DDDEF4EBFCDD34916F7287F3E9A887B8BCF4BBDB83AE98C2BF5F8D1E054BB8B053B268D1E924CA709F5F605E32D9F8D05691445414CF0E583D44F7D81C87D01432896CAC5F3252F12FB1738EC1DD21F6C1F36CF49D8CE9182547781A1510ECEEB80BDCD72F1E9EB6C3B76B0393BD27FD4AD06464C998ABD66A521B4DE5B8AD691EB17D273C219A62372D1E28426C6C6A1D4E3C65981A55119691D6040AD0DE4EC9723C42FD8077CC71F8C6D04F567858C41761D1CC468EDEEB3F788437B83465729B78AA264534AEB7F8E9DD0B1DBBAA6DD53DD840C4D0B74D44C073DFE6D828A66BB986E9FD200B288DDEC14664F9373CC0E9944D0CCCD7877BB1B7772F057E090BE522AC8BF00379A8FB1BFCDD34916F7287F3E9A887B8BCF4BBDDFF61BFE5B3711A6E054BB8B053B268D7AE78231C7B36A80CDF308DF47153EB5414CF0E583D44F7D81C87D01432896CAE16CD156E7715B970EB195D9FE7F9D59D3A73AC1F35077DF49D8CE9182547781A1510ECEEB80BDCD72F1E9EB6C3B76B09ACAD7DB577CF7D15D438A04A17F343BDE5B8AD691EB17D273C219A62372D1E28426C6C6A1D4E3C65981A55119691D6040AD0DE4EC9723C4C14FD0EA7A9D9C9C95D04D1BEB8C0B331AB78B160E748DEF506880D7645D6F9665DD8602FD105749EC70A6F6F8F591E1840C4D0B74D44C073DFE6D828A66BB984AE64BADB587F92214664F9373CC0E99DDB658171E74837B55FC11FCF67A5596D039C2FF7E3FCB7F1258FF4A5409416472641251A15434845251495A4C91645F4ECFB0097E6A44E0B3BEBB89D3B1D33D24FAC8137D1342C49DE14BECBA2473F81441A69CACD7D9C5EDCFF8952C405C61820F2F13BF402690E8886F62C9934182987FAFC40F622198331CA9EF38A5D7778246D420ACEB3F502380A7825D3090455087636E57AA1D8A3483FF5B721C944918DD727C870CE365D115C4779FF1A8756685832D1A021021789EE1D87C08330BF005B88552BEE5247A5A5B7139731278C869547160DCBA10E1E2A73DBB8F360FC6C3F30B81113FEAD964F5771FE62FF6047A7C1006BD331F5FA29B006D5B7730710D3BDEF25C3EDE4ADDEBD173C710F8413F5B76ED31869667F5B766C886CF65909FB41E4012B7B5FD449DB8C7FBFC832A42B029964C51650763EBD986BE033FA92AD74B4A3670EEB3BEBB89D3B1D33D0D947EA225184CEAB6FF8903BB90197690F458262B84CED27D85B23185553196670474EE1DE3F67F83CB2D6DACFA918241D25A8D6D5A8D46858DDCDB27285F3F54EC7BAB4ACD763BDDC64B6B062161FA3BBB534D16EE9B290B8D79A417226F9DA7901B1EE7E4623A6A1DA0D681BE61F21657F4DB4FA653E8774C6C22791BC9E8C6D5E582D3BCD0556E8FC98081872693484C9DBACFBB6B7558FEE236BAB8058CCA66809276B1582617D16AA7D968CD7ABEA301C3443C12F8A09DC8F5833B8DED4349E641CC82595F1DF5FFEFAB38A2152B31DB441C31AFB341448DFA2FAEC6D9BA70E459D83F5EA3216E3661D917C068AD1754983EC3631DD7B3845BC33AC66FF8D321220FC4BB2EEAF8F45963AA07A3CBE54941A53AABC95D2995B72803EED658EBEFA9A132C634C791063CDC22D58E995730AAE8DD063E688D71BD247C712877AA6149A3714B3C7A661A4BB519F31D11B505EAD5278C416F2269D79284062356B1916DBE3C4267278ED7277FD5E5D5FC20EA80078F5F26ABC4A1EF4FE95A4C97BF6AFBF4F902FC017ECAEF9A3C45FFD9C6585B3D4C2C74716B3C677744D1594B96A6320670CF66EB40384B1255A3D1B46F82105006AC51B1A0B52C1D670F4C281D9F5C68CAC540CD66270CDA747AC6F696A97BF13290CC00CCCFCAD43DD4D589FFD8625B9B792AE5B65447FCCEA11DF616292EAF63E8858B589661DEB3E6DB49A3046A047F6EEBD6B1520576864213D304CFDF682F8DDDD5873568D8C9E7164C31927CE1CB44CF55F5738EB46FB8177051828BCA3EFD85D5B071C9352AB7C3D4972623E0D952907771FB50369074883FC1BBEE03C5016E5F5975A815A794FA76CA12C69E5ED30B86C8B64F6B7388FFE9CA210331D383A70C345A9FF7522FFE17473529AB48D6C4AA90573327EA8A8732893BD6A5533A2F748E274B4ADFEA08FDE77D6B31DB80ACFE34C3F2A966876CCC0D6A73DDEC32A91FBA11F7D84BB15A777776DB6DA4FC39616ACB14C9BFFDBE8C1AD6AED40D7BB8A202DE31C71291BB9F6E86271347F1D4579FC0391312D47E28EC01F5CB1BDAF8BC43C9374BED71FE2CF3BD255D66A29B8E750F1BB343CA12FF00B45431AB2EE6EDCFF8952C405C61820F2F13BF402690E8886F62C9934182987FAFC40F622198A163AD7128E6216AEA024B09E4CE94F52380A7825D3090455087636E57AA1D8A3483FF5B721C944918DD727C870CE365D115C4779FF1A875E212EF72BECF17C720AE9AFBD4E460CE2A6CFD8502C1DBABE4F15826A4A04B7F1519DDE41147FBFBAEBCC0F50DED20D4C6C3F30B81113FEAD964F5771FE62FF6916F5F251B4E628C2D8A9FE618A7C8E80E9D8B70A0DB1AC4560C919580CEAABA9A9362950F1B47C767F5B766C886CF65909FB41E4012B7B5FD449DB8C7FBFC83FE34E62F759028CB51D79A253CBFEA5AA92AD74B4A3670EE9BB20A1B4C3253E10D947EA225184CEAB6FF8903BB90197690F458262B84CED27D85B23185553196670474EE1DE3F67F83CB2D6DACFA91829FD7B932F9571B32858DDCDB27285F3F54EC7BAB4ACD763BDDC64B6B062161FA3BBB534D16EE9B290B8D79A417226F9DA7901B1EE7E4623A6A1DA0D681BE61F21657F4DB4FA653E8FD0AC96BB34FF9D2859B5CC2B3AFDD9739866655370AF2146FE4075E342E7D5158FEE236BAB8058CD66EDE45BDF953A4C7FC95B022D8EC2BBEA301C3443C12F8533DC305FE35221C37DCFEFB226AF492545EFF589BA348FA64FC7BEEB11B275886C030C51865B7081258FF4A540941649A6D24CD7A8E779B5251495A4C91645F0DDCB608BDE69DA83C55D7FFD24193A3C4EA3D56E981EFFB9DE14BECBA2473F8939D8E08E0A168F40EB195D9FE7F9D599F0DEF9AFD61FDA5EC5691746B53ADBB1273DE1C87F5816C42CCFB6DCA1CA904D34DBCF06397DC27597A623CD5C8CA60A0B4789C9A7D9FA9895BDAAFB6F543AD44F164DBB2CF9106B78F7564AE388BA6875D0DB7D9028FFFDF947124F79CE86D1EAE6D9BEF7F90FE10227F00BCEF42655103DAA53B70A428439B7DE3A8B7CBA611EA442C6759A752EC2F2839088D7AD572175E7AA9EE7D12AD3E9D86B2F99BCD8FF4BC90B8E43D88C5253EEAEA7F7F6ECD5B47A5E34B8A99078C3CFCD7F01436BCCB5DF0B4BD4262555861AF4B8D97FF5FD7629AB33C2E4FDECEB592FB057BCE60FA4409884D2776551FB0D47478F47B2C134E1E405E8621ECCB5DECAFC9B21558EBEFA9A132C634C791063CDC22D58E8B23A591A510B6B82FAF8F41AB99F16877AA6149A3714B3C7A661A4BB519F31D11B505EAD5278C416F2269D79284062356B1916DBE3C4267278ED7277FD5E5D5A685E65570997B8BDBAC56C0D32CAC1060E66A1EF0A44D84868B20A0D295A9DAA37E636CD1A0A4F4B3B5C99E36F57079F91AFB3EC569049CCBBE519A25D98DA9B051C2D1E218669712EEBA5658F25AF1'

a = int(mi[-1],16) + 9
b = int(mi[a],16)


def fn(a,b,c):
    if a == 0:
        return a[c:]
    data = a[0: 0+b]
    data += a[b+c:]
    return data

mi = fn(mi, a, 1)
a = mi[b:b+8]
mi = fn(mi, b, 8)

key = a.encode('utf-8')

des = DES.new(key=key, mode = DES.MODE_ECB)
ming_bs = des.decrypt(binascii.a2b_hex(mi))
ming_bs = unpad(ming_bs, 8)
ming_str = ming_bs.decode('utf-8')
# print(ming_str)

ming_str = ming_str[0:ming_str.rindex('}') + 1]
# print(ming_str)
# print(json.loads(ming_str))


# 原始数据（假设变量名为 raw_data）
raw_data = json.loads(ming_str)  # 你提供的数据

# 1. 提取并转换为 DataFrame
df = pd.DataFrame(raw_data["Data"]["Table"])

# 2. 检查数据类型
print(df.dtypes)  # 查看字段类型

# 3. 转换数值字段为数字类型（确保无字符串干扰）
numeric_cols = ["BoxOffice", "AvgPrice", "AvgPeoPle"]
df[numeric_cols] = df[numeric_cols].apply(pd.to_numeric, errors="coerce")

# 4. 转换日期字段为 datetime 类型
df["ReleaseTime"] = pd.to_datetime(df["ReleaseTime"], errors="coerce")

# 5. 处理重复的 Movieid
duplicate_ids = df[df.duplicated("Movieid", keep=False)]
if not duplicate_ids.empty:
    print("发现重复 Movieid:\n", duplicate_ids)
    # 根据需求去重，例如保留第一条
    df = df.drop_duplicates(subset="Movieid", keep="first")

# 6. 处理 Area 字段（拆分为列表）
df["Area"] = df["Area"].str.split("/")

# 7. 检查异常值（例如票房为负数）
invalid_boxoffice = df[df["BoxOffice"] < 0]
if not invalid_boxoffice.empty:
    print("异常票房数据:\n", invalid_boxoffice)
    # 可根据业务逻辑修复或删除（此处示例直接删除）
    df = df[df["BoxOffice"] >= 0]

# 8. 处理缺失值（例如填充或删除空值）
if df.isnull().sum().sum() > 0:
    print("缺失值统计:\n", df.isnull().sum())
    # 示例：删除包含缺失值的行
    df = df.dropna()

# 9. 保存清洗后的数据
df.to_csv("cleaned_movies.csv", index=False)